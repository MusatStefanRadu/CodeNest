{% extends 'base.html' %}
{% load static %}

{% block title %}{{ test.title }} - Code Nest{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/base.css' %}">
<link rel="stylesheet" href="{% static 'css/test_details.css' %}">
{% endblock %}

{% block content %}
<div class="test-details-container">
    <!-- Panoul stÃ¢ng -->
    <aside class="side-panel left-panel">
        <h3>Related Tests</h3>
        <ul class="related-tests">
            <li><a href="#">C++ Fundamentals</a></li>
            <li><a href="#">OOP Principles</a></li>
            <li><a href="#">Data Structures</a></li>
            <li><a href="#">Algorithms</a></li>
        </ul>

        <div class="progress-widget">
            <h3>Your Learning Progress</h3>
            <div class="progress-bar">
                <div class="progress" style="width: {{ progress }}%;"></div>
            </div>
            <span>{{ completed_count }} out of {{ total_tests }} tests completed</span>
        </div>
    </aside>

    <!-- ConÈ›inutul principal -->
    <main class="main-content">
        <div class="difficulty-banner {{ test.difficulty|lower }}">{{ test.difficulty }}</div>
        
        <div class="test-header">
            <h1>{{ test.title }}</h1>
            <div class="test-meta">
                <span>{{ test.number_of_questions }} Questions</span>
                <span>Estimated time: {{test.time_in_minutes}} min</span>
            </div>
        </div>

        <div class="test-description">
            <h2>Description</h2>
            <p>{{ test.description }}</p>
        </div>

        <div class="categories-container">
            {% for category in test.categories.all %}
            <div class="category-chip">
                <span class="category-icon">ðŸ“š</span>
                {{ category.title }}
            </div>
            {% empty %}
            <div class="category-chip">
                <span class="category-icon">ðŸ”–</span>
                General
            </div>
            {% endfor %}
        </div>

        <div class="test-actions">
            <a href="#" class="start-test-button">Start Test</a>
            <button class="preview-button" id="previewBtn">Preview Questions</button>
        </div>
    </main>

    <!-- Panoul drept -->
    <aside class="side-panel right-panel">
        <h3>Test Instructions</h3>
        <ol class="instructions-list">
            <li>{{test.time_in_minutes}} minutes time limit</li>
            <li>No external resources allowed</li>
            <li>Answers are auto-saved</li>
            <li>Can't pause once started</li>
        </ol>

        <div class="quick-stats">
            <h3>Test Statistics</h3>
            <div class="stat-item">
                <div class="stat-value">{{ stats.average_score|default:"-" }}</div>
                <div class="stat-label">Average Score</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">
                    {% if stats.completion_rate %}{{ stats.completion_rate }}%{% else %}-{% endif %}
                </div>
                <div class="stat-label">Completion Rate</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ stats.attempts_count }}</div>
                <div class="stat-label">Total Attempts</div>
            </div>
        </div>
    </aside>
</div>

<!-- Modal pentru preview -->
<div id="previewModal" class="preview-modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3 class="modal-title">Sample Questions Preview</h3>
        
        <ul class="question-list">
            {% for question in sample_questions %}
            <li class="question-item">
                <span class="question-number">{{ forloop.counter }}</span>
                <div class="question-content">
                    <p class="question-text">{{ question.text }}</p>
                    {% if question.code_snippet %}
                    <pre class="code-snippet"><code>{{ question.code_snippet }}</code></pre>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<script>
    const modal = document.getElementById("previewModal");
    const btn = document.getElementById("previewBtn");
    const span = document.getElementsByClassName("close-modal")[0];

    // Deschide modalul
    btn.addEventListener('click', function() {
        modal.style.display = "block";
        document.body.style.overflow = "hidden";
    });

    // ÃŽnchide modalul
    span.addEventListener('click', function() {
        modal.style.display = "none";
        document.body.style.overflow = "auto";
    });

    // ÃŽnchide cÃ¢nd se click Ã®n afara
    window.addEventListener('click', function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
            document.body.style.overflow = "auto";
        }
    });

    // ÃŽnchide cu ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape" && modal.style.display == "block") {
            modal.style.display = "none";
            document.body.style.overflow = "auto";
        }
    });


    // ActualizeazÄƒ statisticile Ã®n timp real (pentru alÈ›i utilizatori)
function startStatsPolling(testId) {
    let lastUpdate = {{ stats.last_updated|default:"0" }};
    
    function checkStats() {
        fetch(`/code_nest/test/${testId}/stats/`)
            .then(response => response.json())
            .then(data => {
                if (data.last_updated > lastUpdate) {
                    updateStats(data);
                    lastUpdate = data.last_updated;
                }
            });
    }
    
    // VerificÄƒ la fiecare 15 secunde
    setInterval(checkStats, 15000);
}

function updateStats(data) {
    document.querySelector('.stat-value:nth-child(1)').textContent = 
        data.average_score !== undefined ? data.average_score : '-';
    document.querySelector('.stat-value:nth-child(2)').textContent = 
        data.completion_rate !== undefined ? `${data.completion_rate}%` : '-';
    document.querySelector('.stat-value:nth-child(3)').textContent = 
        data.attempts_count;
}

// PorneÈ™te polling dupÄƒ Ã®ncÄƒrcare
document.addEventListener('DOMContentLoaded', () => {
    startStatsPolling({{ test.id }});
});

</script>
{% endblock %}